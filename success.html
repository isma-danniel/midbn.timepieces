<script>
  // ✅ Replace with your Apps Script Web App URL (/exec)
  const API = "https://script.google.com/macros/s/AKfycbzRr3ySWQ_RbEufl1zlG2thCio_qRnTG9f6Kkvmdb1Z8aJ7JnHaslspD4NaRHcTIgXZ/exec";

  // ✅ Your seller WhatsApp number
  const SELLER_WA = "6738908960";

  const order = JSON.parse(localStorage.getItem("lastOrder"));
  const box = document.querySelector(".box");

  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  function toNumber(v){
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }

  function formatBND(n){
    return "BND " + toNumber(n).toFixed(2);
  }

  function getQty(item){
    return Math.max(1, toNumber(item.qty ?? item.quantity ?? 1));
  }

  function computeDeliveryFee(type, district){
    if(type !== "Delivery") return 0;
    const d = String(district || "").toLowerCase().trim();
    if(d === "bsb" || d.includes("bandar")) return 5;
    if(d.includes("tutong")) return 10;
    if(d.includes("belait") || d.includes("kuala belait")) return 15;
    if(d.includes("temburong")) return 15;
    return 0;
  }

  function setWhatsAppLink(orderIdDisplay){
    const msg =
      "Hi MIDBN.Timepieces, I just placed an order.\n" +
      "Order ID: " + orderIdDisplay + "\n" +
      "Please verify and confirm. Thank you.";
    const url = "https://wa.me/" + SELLER_WA + "?text=" + encodeURIComponent(msg);
    const waBtn = document.getElementById("waBtn");
    waBtn.href = url;
  }

  if(!order || !order.orderId){
    box.innerHTML = "<h2>No order found</h2><div class='mini'>Go back to Products and place order again.</div>";
  } else {
    // Render items immediately from localStorage
    const container = document.getElementById("orderItems");
    container.innerHTML = "";

    const cart = Array.isArray(order.cart) ? order.cart : [];
    cart.forEach(item=>{
      const qty = getQty(item);
      const price = toNumber(item.price);
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <span>${esc(item.name)} (x${qty})</span>
        <span>${formatBND(price * qty)}</span>
      `;
      container.appendChild(div);
    });

    // ✅ Calculate totals (works even if order.total missing)
    const customer = order.customer || {};
    const deliveryType = customer.deliveryType || "Delivery"; // from your checkout.js older save
    const district = customer.district || "";
    const deliveryFee = computeDeliveryFee(deliveryType, district);

    const subtotal = cart.reduce((sum, it) => sum + (getQty(it) * toNumber(it.price)), 0);
    const grandTotal = Math.max(0, subtotal + deliveryFee);

    document.getElementById("orderTotal").innerText =
      "Total: " + formatBND(grandTotal);

    // Default display = existing orderId (fallback)
    let displayId = order.orderId;
    document.getElementById("orderId").innerText = "Order ID: " + displayId;
    setWhatsAppLink(displayId);

    // Auto-refresh status from sheet
    async function refreshStatus(){
      try{
        if(!API || API.includes("PASTE_YOUR_WEBAPP_URL_HERE")) return;

        const res = await fetch(
          API + "?action=order&orderId=" + encodeURIComponent(order.orderId),
          { cache: "no-store" }
        );
        const data = await res.json();
        if(!data || data.status !== "success" || !data.order) return;

        const o = data.order;

        // If server provides a simple order number, use it:
        if (o.simpleOrderId) {
          displayId = String(o.simpleOrderId);
          document.getElementById("orderId").innerText = "Order ID: " + displayId;
          setWhatsAppLink(displayId);
        }

        const statusText = o.status ? String(o.status) : "Pending Verification";
        document.getElementById("orderStatus").innerText = "Status: " + statusText;

        if (String(statusText).toLowerCase() === "approved") {
          clearInterval(window.__midbnTimer);
        }
      } catch(err){
        // ignore refresh errors
      }
    }

    refreshStatus();
    window.__midbnTimer = setInterval(refreshStatus, 3000);

    // optional clear after 2 minutes
    setTimeout(()=> localStorage.removeItem("lastOrder"), 120000);
  }
</script>
